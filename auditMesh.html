<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yiriwa Secure Audit Mesh v5.1 - Patent Demonstration</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animations */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }

        @keyframes slide-in {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in { animation: slide-in 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS (Inline SVG for standalone portability) ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            CreditCard: (p) => <IconWrapper {...p}><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></IconWrapper>,
            ArrowRight: (p) => <IconWrapper {...p}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></IconWrapper>,
            ArrowLeftRight: (p) => <IconWrapper {...p}><path d="M8 3 4 7l4 4" /><path d="M4 7h16" /><path d="m16 21 4-4-4-4" /><path d="M20 17H4" /></IconWrapper>,
            Cpu: (p) => <IconWrapper {...p}><rect x="4" y="4" width="16" height="16" rx="2" /><rect x="9" y="9" width="6" height="6" /><path d="M9 1v3" /><path d="M15 1v3" /><path d="M9 20v3" /><path d="M15 20v3" /><path d="M20 9h3" /><path d="M20 14h3" /><path d="M1 9h3" /><path d="M1 14h3" /></IconWrapper>,
            Lock: (p) => <IconWrapper {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconWrapper>,
            RefreshCw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconWrapper>,
            Server: (p) => <IconWrapper {...p}><rect width="20" height="8" x="2" y="2" rx="2" ry="2" /><rect width="20" height="8" x="2" y="14" rx="2" ry="2" /><line x1="6" x2="6.01" y1="6" y2="6" /><line x1="6" x2="6.01" y1="18" y2="18" /></IconWrapper>,
            ShieldCheck: (p) => <IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /><path d="m9 12 2 2 4-4" /></IconWrapper>,
            Terminal: (p) => <IconWrapper {...p}><polyline points="4 17 10 11 4 5" /><line x1="12" x2="20" y1="19" y2="19" /></IconWrapper>,
            Wifi: (p) => <IconWrapper {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0" /><path d="M1.42 9a16 16 0 0 1 21.16 0" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></IconWrapper>,
            WifiOff: (p) => <IconWrapper {...p}><line x1="1" x2="23" y1="1" y2="23" /><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" /><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" /><path d="M10.71 5.05A16 16 0 0 1 22.58 9" /><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></IconWrapper>,
            Footprints: (p) => <IconWrapper {...p}><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-1 2-1 3 0 .67 1.2 1.59 2 2 .75.41 2 1 2 3 0 3.25-2.45 6-5.5 6S4 19.25 4 16Z" /><path d="M14 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C8.63 6 7 7.8 7 12c0 1.25 1 2 1 3 0 .67-1.2 1.59-2 2-.75.41-2 1-2 3 0 3.25 2.45 6 5.5 6S14 23.25 14 20Z" /></IconWrapper>,
            Binary: (p) => <IconWrapper {...p}><rect x="14" y="14" width="4" height="6" rx="2" /><rect x="6" y="4" width="4" height="6" rx="2" /><path d="M6 20h4" /><path d="M14 10h4" /><path d="M6 14h2v6" /><path d="M14 4h2v6" /></IconWrapper>
        };

        // --- PROTOCOL LOGIC ---
        const BASE62 = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

        // MAPPING: Convert strings to byte IDs and back
        const ITEM_MAP = {
            1: "Drill",
            2: "Saw",
            3: "Coffee",
            4: "Hammer"
        };

        const ITEM_REVERSE_MAP = {
            "Drill": 1,
            "Saw": 2,
            "Coffee": 3,
            "Hammer": 4
        };

        // Decompression (Blockchain Side)
        const decompressBlob = (hex10Bytes) => {
            if (!hex10Bytes || hex10Bytes.length !== 20) return null;
            const dataHex = hex10Bytes.substring(0, 12);
            const macHex = hex10Bytes.substring(12, 20);
            const buffer = dataHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16));
            
            const midInt = (buffer[0] << 16) | (buffer[1] << 8) | buffer[2];
            const amount = (buffer[3] << 8) | buffer[4];
            
            // FIX: Look up the Item Name from the Map using the byte ID
            const itemCode = buffer[5];
            const item = ITEM_MAP[itemCode] || "Unknown";
            
            let tempVal = midInt;
            let power = 238328; 
            let midString = "";
            for (let i = 0; i < 4; i++) {
                const index = Math.floor(tempVal / power);
                midString += BASE62.charAt(index);
                tempVal = tempVal % power;
                power = Math.floor(power / 62);
            }
            return { mid: midString, amount, item, mac: macHex };
        };

        // Compression (Applet Side)
        const appletCompress = (mid, amount, item) => {
            let acc = 0;
            let power = 238328;
            for(let i=0; i<4; i++) {
                acc += BASE62.indexOf(mid[i]) * power;
                power = Math.floor(power/62);
            }
            const b0 = (acc >> 16) & 0xFF;
            const b1 = (acc >> 8) & 0xFF;
            const b2 = acc & 0xFF;
            const b3 = (amount >> 8) & 0xFF;
            const b4 = amount & 0xFF;
            
            // FIX: Convert String Item to Byte ID
            let itemID = typeof item === 'string' ? (ITEM_REVERSE_MAP[item] || 0) : item;
            const b5 = itemID & 0xFF;

            const dataHex = [b0, b1, b2, b3, b4, b5].map(b => b.toString(16).padStart(2,'0')).join('');
            const macHex = Math.floor(Math.random() * 0xFFFFFFFF).toString(16).padStart(8, '0');
            return (dataHex + macHex).toUpperCase();
        };

        // --- COMPONENTS ---

        const CardVisual = ({ balance, storage, isProcessing, operation, label }) => (
            <div className={`relative w-72 h-44 rounded-2xl transition-all duration-500 flex flex-col p-5 overflow-hidden shadow-2xl mx-auto
                ${isProcessing ? 'bg-indigo-900 ring-4 ring-yellow-400 scale-105' : 'bg-slate-900 border-t border-slate-700'}`}>
                
                <div className="flex justify-between items-start mb-6">
                    <div className="w-12 h-9 bg-yellow-500 rounded-md flex items-center justify-center shadow-inner border border-yellow-600 relative overflow-hidden">
                        <Icons.Cpu size={20} className="text-yellow-900 opacity-75" />
                    </div>
                    <div className="text-right">
                        <div className="text-[10px] text-slate-400 font-mono tracking-widest mb-1">SECURE ELEMENT</div>
                        <div className="text-white font-bold font-mono text-xl tracking-tight">${balance.toFixed(2)}</div>
                    </div>
                </div>

                <div className="bg-slate-950/80 rounded-lg p-3 flex-1 border border-slate-800 relative group">
                    <div className="text-[9px] text-slate-500 uppercase font-bold mb-2 flex items-center justify-between">
                        <span className="flex items-center gap-1"><Icons.Lock size={10} /> EEPROM: SLOT 0x01</span>
                        <span className="text-indigo-400">10 BYTES</span>
                    </div>
                    
                    {isProcessing ? (
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/90 z-10 backdrop-blur-sm text-center p-2">
                            <Icons.RefreshCw className="animate-spin text-yellow-400 mb-2" size={24} />
                            <div className="text-[10px] font-mono text-yellow-200 uppercase animate-pulse leading-tight">
                                {operation === 'pop' ? '<<< POPPING OLD LOG' : '>>> PUSHING NEW LOG'}
                            </div>
                        </div>
                    ) : (
                        <div className="font-mono text-center">
                            <div className={`text-sm break-all tracking-widest shadow-green-900/20 drop-shadow-md transition-colors duration-300 ${storage === "00000000000000000000" ? 'text-slate-600' : 'text-green-400'}`}>
                                {storage}
                            </div>
                            <div className="mt-2 flex justify-center gap-2">
                                <span className="text-[9px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700">
                                    {label || "Opaque Blob"}
                                </span>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );

        function AuditMeshSimulation() {
            const [step, setStep] = useState(0); 
            const [isSwapping, setIsSwapping] = useState(false);
            const [cardState, setCardState] = useState({
                balance: 1000.00,
                blob: "00000000000000000000",
                label: "Empty"
            });
            const [txA] = useState({ mid: "0uAi", amount: 450, item: "Drill" });
            const [txB] = useState({ mid: "9xB2", amount: 120, item: "Saw" });
            const [harvestedBlob, setHarvestedBlob] = useState(null);
            const [ledger, setLedger] = useState([]);

            const resetSim = () => {
                setStep(0);
                setIsSwapping(false);
                setCardState({ balance: 1000.00, blob: "00000000000000000000", label: "Empty" });
                setLedger([]);
                setHarvestedBlob(null);
            };

            const processMerchantA = () => {
                const blobA = appletCompress(txA.mid, txA.amount, txA.item);
                setCardState(prev => ({
                    balance: prev.balance - txA.amount,
                    blob: blobA,
                    label: "Log A (Compressed)"
                }));
                setStep(2);
            };

            const executeAtomicSwap = () => {
                setIsSwapping(true); 

                const poppedBlob = cardState.blob;
                setHarvestedBlob(poppedBlob);

                const pushedBlob = appletCompress(txB.mid, txB.amount, txB.item);
                
                // Simulate atomic hardware operation delay
                setTimeout(() => {
                    setCardState(prev => ({
                        balance: prev.balance - txB.amount,
                        blob: pushedBlob,
                        label: "Log B (Compressed)"
                    }));

                    // Simulate Cloud Settlement
                    setTimeout(() => {
                        settleOnBlockchain(poppedBlob, txB.amount);
                        setStep(4);
                        setIsSwapping(false); 
                    }, 800);
                }, 1000);
            };

            const settleOnBlockchain = (blob, currentAmt) => {
                const recovered = decompressBlob(blob);
                const newBlock = {
                    id: ledger.length + 1,
                    currentTx: { amount: currentAmt, mid: "9xB2" },
                    recoveredHistory: recovered,
                    rawBlob: blob
                };
                setLedger([newBlock, ...ledger]);
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center justify-center p-3 bg-indigo-600 rounded-xl shadow-lg shadow-indigo-200 mb-4">
                                <Icons.ArrowLeftRight className="text-white" size={32} />
                            </div>
                            <h1 className="text-3xl font-extrabold text-slate-900 tracking-tight">Secure Audit Mesh v5.1</h1>
                            <div className="flex justify-center flex-wrap gap-4 mt-4 text-sm font-medium text-slate-500">
                                <span className={`px-3 py-1 rounded-full ${step >= 1 ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-200'}`}>1. Merchant A (Source)</span>
                                <span className={`px-3 py-1 rounded-full ${step >= 2 ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-200'}`}>2. Transit</span>
                                <span className={`px-3 py-1 rounded-full ${step >= 3 ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-200'}`}>3. Merchant B (Sync)</span>
                            </div>
                        </div>

                        {step === 0 && (
                            <div className="flex justify-center mb-12 animate-fade-in-up">
                                <button onClick={() => setStep(1)} className="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold hover:bg-slate-800 shadow-xl flex items-center gap-3 transition-transform hover:scale-105">
                                    <Icons.Cpu size={20} /> Start Transaction Chain
                                </button>
                            </div>
                        )}

                        <div className={`grid grid-cols-1 lg:grid-cols-3 gap-8 transition-opacity duration-500 ${step === 0 ? 'opacity-30 pointer-events-none' : 'opacity-100'}`}>
                            
                            {/* LEFT: TERMINAL */}
                            <div className="flex flex-col gap-4 relative min-h-[300px]">
                                
                                {/* Merchant A (Offline) */}
                                <div className={`absolute inset-0 transition-all duration-500 transform ${step === 1 ? 'translate-x-0 opacity-100 z-10' : '-translate-x-full opacity-0 z-0'}`}>
                                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 h-full overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-1 bg-orange-500"></div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="font-bold text-lg flex items-center gap-2">
                                                <Icons.Terminal size={18} className="text-slate-400" /> Merchant A
                                            </h2>
                                            <span className="text-[10px] font-bold bg-orange-100 text-orange-700 px-2 py-1 rounded flex gap-1 items-center"><Icons.WifiOff size={10}/> OFFLINE</span>
                                        </div>
                                        <div className="space-y-4">
                                            <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                                <div className="text-xs font-bold text-slate-400 uppercase mb-1">Selling Item</div>
                                                <div className="font-mono text-xl font-bold">${txA.amount} <span className="text-slate-400 text-sm font-normal">{txA.item}</span></div>
                                            </div>
                                            <button onClick={processMerchantA} className="w-full py-4 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                                                <Icons.CreditCard size={18} /> Tap to Pay
                                            </button>
                                            <p className="text-xs text-slate-400 text-center">Applet will compress & store this log.</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Transit */}
                                {step === 2 && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-center p-6 bg-slate-100 rounded-2xl border-2 border-dashed border-slate-300 z-20 animate-fade-in-up">
                                        <Icons.Footprints size={48} className="text-slate-300 mb-4 animate-pulse" />
                                        <h3 className="font-bold text-slate-500">In Transit</h3>
                                        <p className="text-sm text-slate-400 mt-2">User carries the "Ghost Blob" physically to the next location.</p>
                                        <button onClick={() => setStep(3)} className="mt-6 px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-full hover:bg-indigo-700 transition-colors">
                                            Arrive at Merchant B
                                        </button>
                                    </div>
                                )}

                                {/* Merchant B (Online) */}
                                <div className={`absolute inset-0 transition-all duration-500 transform ${step >= 3 ? 'translate-x-0 opacity-100 z-10' : 'translate-x-full opacity-0 z-0'}`}>
                                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 h-full overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-1 bg-green-500"></div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="font-bold text-lg flex items-center gap-2">
                                                <Icons.Terminal size={18} className="text-slate-400" /> Merchant B
                                            </h2>
                                            <span className="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded flex gap-1 items-center"><Icons.Wifi size={10}/> ONLINE</span>
                                        </div>
                                        
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100 mb-4">
                                            <div className="text-xs font-bold text-slate-400 uppercase mb-1">Selling Item</div>
                                            <div className="font-mono text-xl font-bold">${txB.amount} <span className="text-slate-400 text-sm font-normal">{txB.item}</span></div>
                                        </div>

                                        <div className="p-3 bg-yellow-50 rounded-xl border border-yellow-100 mb-4">
                                            <div className="text-[10px] font-bold text-yellow-600 uppercase mb-1">Harvest (The Pop)</div>
                                            <div className="font-mono text-xs text-yellow-800 break-all bg-white/50 p-2 rounded">
                                                {harvestedBlob || "Waiting for card..."}
                                            </div>
                                        </div>

                                        <button 
                                            onClick={executeAtomicSwap} 
                                            disabled={step !== 3 || isSwapping} 
                                            className={`w-full py-4 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-all 
                                            ${step === 3 && !isSwapping ? 'bg-green-600 hover:bg-green-700 text-white active:scale-95' : 'bg-slate-100 text-slate-400'}`}
                                        >
                                            {isSwapping ? (
                                                <Icons.RefreshCw size={18} className="animate-spin" />
                                            ) : step === 4 ? (
                                                <Icons.ShieldCheck size={18} />
                                            ) : (
                                                <Icons.RefreshCw size={18} />
                                            )}
                                            
                                            {isSwapping ? "Processing..." : step === 4 ? "Swap Complete" : "Execute Swap"}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* MIDDLE: CARD */}
                            <div className="flex flex-col items-center justify-center">
                                <CardVisual 
                                    balance={cardState.balance} 
                                    storage={cardState.blob} 
                                    isProcessing={isSwapping} 
                                    label={cardState.label}
                                />
                                <div className="mt-8 text-center text-sm text-slate-500 px-4">
                                    {step === 1 && "Empty slot. Ready to store Merchant A data."}
                                    {step === 2 && "Carrying Merchant A's compressed log (Offline)."}
                                    {step >= 3 && "Swap Complete. Carrying Merchant B's log."}
                                </div>
                            </div>

                            {/* RIGHT: LEDGER */}
                            <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-700 h-full min-h-[400px] text-slate-300 relative overflow-hidden flex flex-col">
                                <div className="absolute top-0 left-0 w-full h-1 bg-indigo-500"></div>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="font-bold text-lg flex items-center gap-2 text-white">
                                        <Icons.Server size={18} className="text-indigo-400" /> Ledger
                                    </h2>
                                    <span className="text-[10px] font-bold bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded border border-indigo-500/50">SMART CONTRACT</span>
                                </div>

                                <div className="space-y-3 overflow-y-auto flex-1 custom-scrollbar pr-1">
                                    {ledger.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-600 italic text-sm">
                                            <div className="mb-2 opacity-50"><Icons.Binary size={32}/></div>
                                            Waiting for sync...
                                        </div>
                                    ) : (
                                        ledger.map(block => (
                                            <div key={block.id} className="bg-slate-800 p-3 rounded-lg border border-slate-700/50 text-xs animate-slide-in">
                                                <div className="flex justify-between mb-2 border-b border-slate-700 pb-2">
                                                    <span className="font-bold text-white">BLOCK #{block.id}</span>
                                                    <span className="text-green-400 font-bold">SETTLED</span>
                                                </div>
                                                
                                                <div className="flex justify-between mb-1 opacity-75">
                                                    <span>Current (Merch B):</span>
                                                    <span>${block.currentTx.amount}</span>
                                                </div>

                                                {block.recoveredHistory && (
                                                    <div className="mt-2 bg-indigo-900/30 p-2 rounded border border-indigo-500/30">
                                                        <div className="text-[9px] font-bold text-indigo-400 uppercase mb-1">
                                                            Decompressed History (Merch A)
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-x-2 gap-y-1 font-mono text-indigo-200">
                                                            <span>MID:</span> <span className="text-white">{block.recoveredHistory.mid}</span>
                                                            <span>AMT:</span> <span className="text-white">${block.recoveredHistory.amount}</span>
                                                            <span>ITM:</span> <span className="text-white">{block.recoveredHistory.item}</span>
                                                        </div>
                                                        <div className="mt-1 pt-1 border-t border-indigo-500/20 text-[9px] text-slate-500 truncate">
                                                            Src: {block.rawBlob}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>

                        {step === 4 && (
                            <div className="mt-12 flex justify-center pb-8">
                                <button onClick={resetSim} className="text-slate-500 hover:text-slate-800 underline">Reset Simulation</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AuditMeshSimulation />);
    </script>
</body>
</html>
