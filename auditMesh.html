<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yiriwa Secure Audit Mesh v6.0 - Batch Harvesting</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animations */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }

        @keyframes slide-in {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in { animation: slide-in 0.4s ease-out forwards; }
        
        .storage-stripe {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.1) 5px,
                rgba(255, 255, 255, 0.1) 10px
            );
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            CreditCard: (p) => <IconWrapper {...p}><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></IconWrapper>,
            Database: (p) => <IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></IconWrapper>,
            Wifi: (p) => <IconWrapper {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0" /><path d="M1.42 9a16 16 0 0 1 21.16 0" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></IconWrapper>,
            WifiOff: (p) => <IconWrapper {...p}><line x1="1" x2="23" y1="1" y2="23" /><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" /><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" /><path d="M10.71 5.05A16 16 0 0 1 22.58 9" /><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></IconWrapper>,
            Layers: (p) => <IconWrapper {...p}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></IconWrapper>,
            Server: (p) => <IconWrapper {...p}><rect width="20" height="8" x="2" y="2" rx="2" ry="2" /><rect width="20" height="8" x="2" y="14" rx="2" ry="2" /><line x1="6" x2="6.01" y1="6" y2="6" /><line x1="6" x2="6.01" y1="18" y2="18" /></IconWrapper>,
            CheckCircle: (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></IconWrapper>,
            CloudLightning: (p) => <IconWrapper {...p}><path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973" /><path d="m13 12-3 5h4l-3 5" /></IconWrapper>,
            Trash2: (p) => <IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconWrapper>,
            Plus: (p) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconWrapper>
        };

        // --- PROTOCOL LOGIC ---
        const BASE62 = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        const ITEM_MAP = { 1: "Coffee", 2: "Donut", 3: "Drill", 4: "Saw", 5: "Milk", 6: "Bread" };
        const ITEM_REVERSE_MAP = { "Coffee": 1, "Donut": 2, "Drill": 3, "Saw": 4, "Milk": 5, "Bread": 6 };

        // v6 Compression
        const appletCompress = (mid, amount, item) => {
            let acc = 0;
            let power = 238328;
            for(let i=0; i<4; i++) {
                acc += BASE62.indexOf(mid[i]) * power;
                power = Math.floor(power/62);
            }
            const b0 = (acc >> 16) & 0xFF;
            const b1 = (acc >> 8) & 0xFF;
            const b2 = acc & 0xFF;
            const b3 = (amount >> 8) & 0xFF;
            const b4 = amount & 0xFF;
            let itemID = typeof item === 'string' ? (ITEM_REVERSE_MAP[item] || 0) : item;
            const b5 = itemID & 0xFF;
            
            const dataHex = [b0, b1, b2, b3, b4, b5].map(b => b.toString(16).padStart(2,'0')).join('');
            const macHex = Math.floor(Math.random() * 0xFFFFFFFF).toString(16).padStart(8, '0');
            const isoHex = "01F8"; // 504 Morocco
            return (dataHex + macHex + isoHex).toUpperCase();
        };

        const decompressLog = (hex12Bytes) => {
            if (!hex12Bytes || hex12Bytes.length < 24) return null; // 12 bytes = 24 chars
            const buffer = hex12Bytes.match(/.{1,2}/g).map(byte => parseInt(byte, 16));
            const midInt = (buffer[0] << 16) | (buffer[1] << 8) | buffer[2];
            const amount = (buffer[3] << 8) | buffer[4];
            const item = ITEM_MAP[buffer[5]] || "Unknown";
            
            let tempVal = midInt;
            let power = 238328;
            let midString = "";
            for (let i = 0; i < 4; i++) {
                const index = Math.floor(tempVal / power);
                midString += BASE62.charAt(index);
                tempVal = tempVal % power;
                power = Math.floor(power / 62);
            }
            return { mid: midString, amount, item };
        };

        // --- COMPONENTS ---

        const CardVisual = ({ balance, logs, maxLogs, isProcessing, mode }) => {
            const usagePercent = (logs.length / maxLogs) * 100;
            
            return (
                <div className={`relative w-72 h-44 rounded-2xl transition-all duration-500 flex flex-col p-5 overflow-hidden shadow-2xl mx-auto
                    ${isProcessing ? 'bg-indigo-900 ring-4 ring-yellow-400 scale-105' : 'bg-slate-900 border-t border-slate-700'}`}>
                    
                    {/* Header */}
                    <div className="flex justify-between items-start mb-4">
                        <div className="w-10 h-8 bg-yellow-500 rounded flex items-center justify-center shadow-inner border border-yellow-600">
                            <Icons.CreditCard size={18} className="text-yellow-900 opacity-75" />
                        </div>
                        <div className="text-right">
                            <div className="text-[9px] text-slate-400 font-mono tracking-widest mb-1">SECURE ELEMENT</div>
                            <div className="text-white font-bold font-mono text-lg tracking-tight">${balance.toFixed(2)}</div>
                        </div>
                    </div>

                    {/* EEPROM Visual */}
                    <div className="bg-slate-950/80 rounded-lg p-2 flex-1 border border-slate-800 relative flex flex-col justify-between">
                        
                        {/* Storage Bar */}
                        <div className="mb-2">
                            <div className="flex justify-between text-[8px] text-slate-500 font-bold uppercase mb-1">
                                <span>Storage (Records)</span>
                                <span>{logs.length} / {maxLogs}</span>
                            </div>
                            <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
                                <div className={`h-full transition-all duration-500 ${logs.length > 280 ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${Math.max(usagePercent, logs.length > 0 ? 5 : 0)}%` }}></div>
                            </div>
                        </div>

                        {/* Logs Stack */}
                        <div className="flex-1 overflow-hidden relative">
                            {isProcessing ? (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm z-10">
                                    <Icons.Layers className="animate-bounce text-yellow-400 mb-2" size={24} />
                                    <div className="text-[9px] font-mono text-yellow-200 uppercase animate-pulse">
                                        {mode === 'append' ? 'Writing EEPROM...' : 'Harvesting Batch...'}
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col-reverse gap-1 h-full">
                                    {logs.slice(-3).map((log, i) => (
                                        <div key={i} className="h-4 bg-slate-800 border border-slate-700 rounded text-[8px] font-mono text-green-400 flex items-center px-2 truncate">
                                            <span className="opacity-50 mr-2">#{logs.length - i}:</span> {log.substring(0, 16)}...
                                        </div>
                                    ))}
                                    {logs.length > 3 && (
                                        <div className="text-[8px] text-center text-slate-600">... {logs.length - 3} more ...</div>
                                    )}
                                    {logs.length === 0 && (
                                        <div className="h-full flex items-center justify-center text-[9px] text-slate-700 italic">Empty Storage</div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        function AuditMeshV6Simulation() {
            const [logs, setLogs] = useState([]);
            const [balance, setBalance] = useState(2500.00);
            const [ledger, setLedger] = useState([]);
            const [processing, setProcessing] = useState(false);
            const [mode, setMode] = useState(null); // 'append' or 'harvest'
            
            // Random Transaction Generator
            const generateTx = (mid) => {
                const itemKeys = Object.keys(ITEM_REVERSE_MAP);
                const randomItem = itemKeys[Math.floor(Math.random() * itemKeys.length)];
                const randomAmt = Math.floor(Math.random() * 50) + 5;
                return { mid, amount: randomAmt, item: randomItem };
            };

            // 1. OFFLINE TRANSACTION (APPEND)
            const handleOfflineTx = (merchantName, mid) => {
                if (processing) return;
                setProcessing(true);
                setMode('append');

                const tx = generateTx(mid);
                const compressed = appletCompress(tx.mid, tx.amount, tx.item);

                // Simulate Card Processing Delay
                setTimeout(() => {
                    setBalance(prev => prev - tx.amount);
                    setLogs(prev => [...prev, compressed]);
                    setProcessing(false);
                    setMode(null);
                }, 800);
            };

            // 2. ONLINE TRANSACTION (HARVEST & SWAP)
            const handleOnlineTx = (mid) => {
                if (processing) return;
                setProcessing(true);
                setMode('harvest');

                const tx = generateTx(mid);
                const newLog = appletCompress(tx.mid, tx.amount, tx.item);

                // 1. Harvest existing logs
                const harvestedBatch = [...logs];
                
                setTimeout(() => {
                    // 2. Clear Card & Add New Log
                    setLogs([newLog]);
                    setBalance(prev => prev - tx.amount);

                    // 3. Settle on Blockchain (Async)
                    if (harvestedBatch.length > 0) {
                        const decodedBatch = harvestedBatch.map(l => decompressLog(l));
                        const newBlock = {
                            id: ledger.length + 1,
                            location: "Merchant B (Online)",
                            harvested: decodedBatch,
                            timestamp: new Date().toLocaleTimeString()
                        };
                        setLedger(prev => [newBlock, ...prev]);
                    }

                    setProcessing(false);
                    setMode(null);
                }, 1200);
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        
                        {/* HEADER */}
                        <div className="flex flex-col md:flex-row justify-between items-center mb-10 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div>
                                <h1 className="text-2xl font-extrabold text-slate-900 tracking-tight mb-1 flex items-center gap-2">
                                    <Icons.Database className="text-indigo-600" /> Secure Audit Mesh v6.0
                                </h1>
                                <p className="text-sm text-slate-500">Batch Harvesting & Atomic Swap Protocol</p>
                            </div>
                            <div className="flex gap-4 mt-4 md:mt-0">
                                <div className="text-xs font-mono bg-slate-100 px-3 py-2 rounded text-slate-600">
                                    LOG_SIZE: 12 Bytes
                                </div>
                                <div className="text-xs font-mono bg-slate-100 px-3 py-2 rounded text-slate-600">
                                    MAX_LOGS: 300
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* LEFT: TERMINALS */}
                            <div className="lg:col-span-4 space-y-6">
                                <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">Terminals</h2>
                                
                                {/* Merchant A (Offline) */}
                                <div className="bg-white p-5 rounded-xl shadow-md border-l-4 border-orange-500 transition-transform hover:scale-[1.02]">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="font-bold text-slate-800 flex items-center gap-2">
                                            <Icons.WifiOff size={16} className="text-orange-500"/> Café (Offline)
                                        </div>
                                        <span className="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded font-bold">APPEND MODE</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mb-4">Cannot sync. Adds encrypted log to card storage.</p>
                                    <button onClick={() => handleOfflineTx("Café", "0uAi")} disabled={processing} className="w-full py-3 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-slate-800 disabled:opacity-50 flex justify-center items-center gap-2">
                                        <Icons.Plus size={16}/> Buy Coffee ($5-$50)
                                    </button>
                                </div>

                                {/* Merchant C (Offline) */}
                                <div className="bg-white p-5 rounded-xl shadow-md border-l-4 border-orange-500 transition-transform hover:scale-[1.02]">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="font-bold text-slate-800 flex items-center gap-2">
                                            <Icons.WifiOff size={16} className="text-orange-500"/> Bakery (Offline)
                                        </div>
                                        <span className="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded font-bold">APPEND MODE</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mb-4">Simulate accumulation. Stack more logs.</p>
                                    <button onClick={() => handleOfflineTx("Bakery", "8kLm")} disabled={processing} className="w-full py-3 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-slate-800 disabled:opacity-50 flex justify-center items-center gap-2">
                                        <Icons.Plus size={16}/> Buy Pastry ($5-$50)
                                    </button>
                                </div>

                                {/* Merchant B (Online) */}
                                <div className="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500 relative overflow-hidden transition-transform hover:scale-[1.02]">
                                    <div className="storage-stripe absolute top-0 right-0 w-24 h-24 opacity-10 rounded-bl-full pointer-events-none"></div>
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="font-bold text-slate-800 flex items-center gap-2">
                                            <Icons.Wifi size={16} className="text-green-600"/> Supermarket (Online)
                                        </div>
                                        <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold">HARVEST MODE</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mb-4">Syncs card. Extracts ALL logs, clears memory, adds new log.</p>
                                    <button onClick={() => handleOnlineTx("9xB2")} disabled={processing} className="w-full py-3 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700 disabled:opacity-50 flex justify-center items-center gap-2 shadow-lg shadow-green-200">
                                        <Icons.CloudLightning size={16}/> Buy Groceries & Sync
                                    </button>
                                </div>
                            </div>

                            {/* CENTER: CARD */}
                            <div className="lg:col-span-4 flex flex-col items-center justify-start pt-10">
                                <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6">User Wallet</h2>
                                <CardVisual 
                                    balance={balance} 
                                    logs={logs} 
                                    maxLogs={300} 
                                    isProcessing={processing}
                                    mode={mode}
                                />
                                <div className="mt-8 text-center px-6">
                                    <div className="text-xs text-slate-500 mb-2 font-mono bg-white inline-block px-3 py-1 rounded border border-slate-200">
                                        Logs in RAM/EEPROM: <span className="font-bold text-slate-800">{logs.length}</span>
                                    </div>
                                    <p className="text-xs text-slate-400 leading-relaxed">
                                        The card accumulates transactions securely offline. 
                                        Once it touches an Online terminal, the entire history is "Harvested" to the cloud.
                                    </p>
                                </div>
                            </div>

                            {/* RIGHT: LEDGER */}
                            <div className="lg:col-span-4 h-full flex flex-col">
                                <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">Blockchain Ledger</h2>
                                <div className="bg-slate-900 rounded-xl border border-slate-800 flex-1 overflow-hidden flex flex-col min-h-[500px]">
                                    <div className="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center">
                                        <span className="text-xs font-bold text-slate-400 flex items-center gap-2">
                                            <Icons.Server size={14}/> IMMUTABLE RECORD
                                        </span>
                                        <span className="text-[10px] text-slate-600 font-mono">Synced: {ledger.length} Blocks</span>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                                        {ledger.length === 0 ? (
                                            <div className="h-full flex flex-col items-center justify-center opacity-30 text-center">
                                                <Icons.Database size={48} className="text-slate-500 mb-4" />
                                                <p className="text-slate-400 text-sm">No blocks mined yet.</p>
                                                <p className="text-slate-600 text-xs mt-1">Visit an Online Terminal to sync.</p>
                                            </div>
                                        ) : (
                                            ledger.map(block => (
                                                <div key={block.id} className="bg-slate-800 rounded-lg p-3 border border-slate-700 animate-slide-in">
                                                    <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-700">
                                                        <span className="text-green-400 font-bold text-xs flex items-center gap-1">
                                                            <Icons.CheckCircle size={10}/> Block #{block.id}
                                                        </span>
                                                        <span className="text-[10px] text-slate-500">{block.timestamp}</span>
                                                    </div>
                                                    <div className="mb-2">
                                                        <span className="text-[10px] text-slate-400 uppercase">Miner:</span>
                                                        <div className="text-xs text-white font-bold">{block.location}</div>
                                                    </div>
                                                    <div className="bg-indigo-500/10 rounded p-2 border border-indigo-500/20">
                                                        <div className="text-[9px] text-indigo-300 font-bold uppercase mb-1 flex items-center gap-1">
                                                            <Icons.Layers size={8}/> Recovered Logs ({block.harvested.length})
                                                        </div>
                                                        <div className="space-y-1">
                                                            {block.harvested.map((tx, idx) => (
                                                                <div key={idx} className="flex justify-between text-[10px] font-mono text-slate-300">
                                                                    <span>{tx.mid}</span>
                                                                    <span className="text-slate-500">{tx.item}</span>
                                                                    <span className="text-white">${tx.amount}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AuditMeshV6Simulation />);
    </script>
</body>
</html>
