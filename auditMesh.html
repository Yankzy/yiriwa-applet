<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yiriwa v7 Sim - Credit & Debit Flows</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        /* Animations */
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .recharge-pulse { animation: pulse-ring 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // --- ICONS ---
        const Icon = ({ name, size=20, className="" }) => {
            const icons = {
                wifi: <path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>,
                wifiOff: <line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>,
                card: <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/>,
                database: <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>,
                plus: <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>,
                minus: <line x1="5" y1="12" x2="19" y2="12"/>,
                bank: <polygon points="12 2 2 7 22 7 12 2"/><polyline points="2 7 2 22 22 22 22 7"/><line x1="7" x2="7" y1="7" y2="22"/><line x1="12" x2="12" y1="7" y2="22"/><line x1="17" x2="17" y1="7" y2="22"/>,
                fingerprint: <path d="M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 4"/><path d="M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2"/><path d="M17.29 21.02c.12-.6.41-2.3.41-4.02 0-3.49-2.55-6.57-6.3-7C5.7 8.5 2 11.5 2 16.5 2 17.8 2 19 2.5 20.5"/><path d="M12 14v4"/><path d="M15 15c.66-1.3 1-2.7 1-4.5 0-2.5-1.5-4.5-3-5.5"/>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        // --- CONSTANTS ---
        const WALLET_ID = "1A2B3C4D"; // The fixed 4-byte Identity Header
        const MAX_LOGS = 300;

        // --- CARD COMPONENT ---
        const CardVisual = ({ balance, logs, procState }) => {
            const isRecharging = procState.type === 'credit';
            const isSpending = procState.type === 'debit' || procState.type === 'harvest';
            
            return (
                <div className={`relative w-full max-w-sm aspect-[1.58/1] rounded-2xl p-6 flex flex-col justify-between overflow-hidden transition-all duration-300
                    ${isRecharging ? 'bg-blue-900/40 ring-2 ring-blue-500 recharge-pulse' : 
                      isSpending ? 'bg-orange-900/40 ring-2 ring-orange-500' : 'bg-slate-800 border border-slate-700 shadow-2xl'}`}>
                    
                    {/* Background Pattern */}
                    <div className="absolute inset-0 opacity-10 pointer-events-none bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-slate-100 via-slate-900 to-slate-900"></div>

                    {/* Header: Identity */}
                    <div className="flex justify-between items-start relative z-10">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-slate-700/50 rounded-lg border border-slate-600">
                                <Icon name="card" className="text-slate-300"/>
                            </div>
                            <div>
                                <div className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Wallet Identity</div>
                                <div className="font-mono text-sm text-indigo-400 flex items-center gap-1">
                                    <Icon name="fingerprint" size={14}/> 0x{WALLET_ID}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Middle: Processing Overlay */}
                    <div className="flex-1 flex items-center justify-center relative z-10">
                        {procState.isProcessing && (
                           <div className={`px-4 py-2 rounded-full font-bold text-sm flex items-center gap-2 animate-pulse
                                ${isRecharging ? 'bg-blue-500/20 text-blue-300' : 'bg-orange-500/20 text-orange-300'}`}>
                                {isRecharging ? <Icon name="plus" size={16}/> : <Icon name="minus" size={16}/>}
                                {procState.label}
                           </div>
                        )}
                    </div>

                    {/* Footer: Balance & Storage */}
                    <div className="flex justify-between items-end relative z-10">
                        <div>
                            <div className="text-[10px] uppercase text-slate-500 font-bold tracking-wider mb-1">
                                Offline Logs ({logs.length}/{MAX_LOGS})
                            </div>
                            <div className="flex h-3 w-32 bg-slate-700 rounded-full overflow-hidden border border-slate-600">
                                <div className="bg-orange-500 transition-all duration-500" style={{width: `${(logs.length/MAX_LOGS)*100}%`}}></div>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Available Balance</div>
                            <div className={`text-3xl font-bold font-mono transition-colors duration-300 ${isRecharging ? 'text-blue-400' : balance < 20 ? 'text-red-400' : 'text-white'}`}>
                                ${balance.toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            const [balance, setBalance] = useState(45.00);
            const [logs, setLogs] = useState([]);
            const [ledger, setLedger] = useState([]);
            // procState: { isProcessing: bool, type: 'credit'|'debit'|'harvest', label: string }
            const [procState, setProcState] = useState({ isProcessing: false, type: '', label: '' });

            const simulateProcessing = (type, label, duration, callback) => {
                if(procState.isProcessing) return;
                setProcState({ isProcessing: true, type, label });
                setTimeout(() => {
                    callback();
                    setProcState({ isProcessing: false, type: '', label: '' });
                }, duration);
            };

            // --- FLOW 1: CREDIT (Recharge) ---
            const handleRecharge = (amount) => {
                simulateProcessing('credit', `Adding Funds...`, 1000, () => {
                    setBalance(prev => prev + amount);
                    // Note: Logs remain untouched in credit flow
                });
            };

            // --- FLOW 2: DEBIT (Offline - Append) ---
            const handleOfflineSpend = (amount) => {
                if(balance < amount) return alert("Insufficient Funds");
                if(logs.length >= MAX_LOGS) return alert("Storage Full. Sync required.");
                
                simulateProcessing('debit', 'Processing Offline...', 800, () => {
                    setBalance(prev => prev - amount);
                    // Simulate an encrypted log entry representing the tx
                    setLogs(prev => [...prev, `EncLog_${Date.now().toString(16)}`]);
                });
            };

            // --- FLOW 3: DEBIT (Online - Harvest & Swap) ---
            const handleOnlineSpendAndSync = (amount) => {
                if(balance < amount) return alert("Insufficient Funds");

                simulateProcessing('harvest', 'Harvesting & Syncing...', 1500, () => {
                    const harvestedLogs = [...logs]; // 1. "Harvest" existing logs
                    
                    setBalance(prev => prev - amount); // 2. Debit current amount
                    setLogs([]); // 3. Clear card storage (Swap/Reset)

                    // 4. Update Ledger with Identity Header
                    if(harvestedLogs.length > 0) {
                        const newBlock = {
                            id: ledger.length + 1,
                            walletID: WALLET_ID, // THE IDENTITY HEADER
                            logCount: harvestedLogs.length,
                            timestamp: new Date().toLocaleTimeString(),
                            hash: Math.random().toString(36).substring(2, 10).toUpperCase()
                        };
                        setLedger(prev => [newBlock, ...prev]);
                    }
                });
            };

            return (
                <div className="max-w-5xl mx-auto">
                    {/* Header */}
                    <div className="mb-8">
                        <h1 className="text-3xl font-extrabold text-white tracking-tight flex items-center gap-3">
                            <Icon name="database" size={28} className="text-indigo-500"/> 
                            Yiriwa v7 Simulation
                        </h1>
                        <p className="text-slate-400 mt-2">Demonstrating secure Credit (Recharge) and Debit (Offline/Online) flows with Identity linking.</p>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                        
                        {/* LEFT: Terminals (Points of Service) */}
                        <div className="lg:col-span-4 space-y-6 order-2 lg:order-1">
                            <h2 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Points of Service</h2>
                            
                            {/* 1. Bank Agent (Recharge) */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-blue-900/30 shadow-lg relative overflow-hidden group">
                                <div className="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-blue-900/50 text-blue-400 rounded-lg"><Icon name="bank"/></div>
                                    <div>
                                        <div className="text-white font-bold">Bank Agent</div>
                                        <div className="text-xs text-blue-400 font-medium">Secure Recharge Point</div>
                                    </div>
                                </div>
                                <button onClick={() => handleRecharge(100)} disabled={procState.isProcessing} 
                                    className="w-full py-3 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors">
                                    <Icon name="plus" size={18}/> Add $100.00 Credit
                                </button>
                            </div>

                            {/* 2. Offline Merchant */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-orange-900/30 shadow-lg relative overflow-hidden group">
                                <div className="absolute inset-0 bg-orange-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-orange-900/50 text-orange-400 rounded-lg"><Icon name="wifiOff"/></div>
                                    <div>
                                        <div className="text-white font-bold">Remote Vendor</div>
                                        <div className="text-xs text-orange-400 font-medium">Offline Debit (Appends Log)</div>
                                    </div>
                                </div>
                                <button onClick={() => handleOfflineSpend(15)} disabled={procState.isProcessing}
                                    className="w-full py-3 bg-orange-700 hover:bg-orange-600 disabled:opacity-50 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors">
                                    <Icon name="minus" size={18}/> Spend $15.00
                                </button>
                            </div>

                             {/* 3. Online Merchant */}
                             <div className="bg-slate-800 p-4 rounded-xl border border-green-900/30 shadow-lg relative overflow-hidden group">
                                <div className="absolute inset-0 bg-green-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-green-900/50 text-green-400 rounded-lg"><Icon name="wifi"/></div>
                                    <div>
                                        <div className="text-white font-bold">City Supermarket</div>
                                        <div className="text-xs text-green-400 font-medium">Online Debit (Harvests Logs)</div>
                                    </div>
                                </div>
                                <button onClick={() => handleOnlineSpendAndSync(40)} disabled={procState.isProcessing}
                                    className="w-full py-3 bg-green-700 hover:bg-green-600 disabled:opacity-50 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors">
                                    <Icon name="minus" size={18}/> Spend $40.00 & Sync
                                </button>
                            </div>
                        </div>

                        {/* CENTER: The Card */}
                        <div className="lg:col-span-5 flex flex-col items-center order-1 lg:order-2 sticky top-8">
                            <CardVisual balance={balance} logs={logs} procState={procState} />
                            
                            <div className="mt-6 text-center px-8">
                                <h3 className="text-sm font-bold text-white mb-2">Device State Flow</h3>
                                <p className="text-xs text-slate-400 leading-relaxed mb-4">
                                    <span className="text-blue-400 font-bold">Credit:</span> Increases balance securely via Bank Agent. No logs added.<br/>
                                    <span className="text-orange-400 font-bold">Offline Debit:</span> Decreases balance, stores encrypted log internally.<br/>
                                    <span className="text-green-400 font-bold">Online Debit:</span> Decreases balance, offloads ALL stored logs to the ledger.
                                </p>
                                <div className="inline-block text-xs font-mono bg-slate-800 text-slate-300 px-3 py-1.5 rounded-lg border border-slate-700">
                                    Current Logs in EEPROM: <span className="text-white font-bold">{logs.length}</span>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: The Ledger */}
                        <div className="lg:col-span-3 order-3 h-full min-h-[400px] flex flex-col">
                             <h2 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Blockchain Ledger</h2>
                             <div className="bg-slate-900/50 rounded-xl border border-slate-800 flex-1 overflow-hidden flex flex-col font-mono">
                                 <div className="p-3 bg-slate-800/80 border-b border-slate-700 text-[10px] text-slate-400 flex justify-between">
                                     <span>IMMUTABLE LOGS</span>
                                     <span>SYNCED BLOCKS: {ledger.length}</span>
                                 </div>
                                 <div className="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                                     {ledger.length === 0 ? (
                                         <div className="h-full flex items-center justify-center text-xs text-slate-600 italic">Waiting for harvest...</div>
                                     ) : (
                                         ledger.map(block => (
                                             <div key={block.id} className="bg-slate-800 p-3 rounded-lg border-l-2 border-indigo-500 text-xs animate-slide-in">
                                                 <div className="flex justify-between mb-2">
                                                     <span className="text-indigo-400 font-bold">BLOCK #{block.id}</span>
                                                     <span className="text-slate-500">{block.timestamp}</span>
                                                 </div>
                                                 {/* IDENTITY HEADER VISUALIZATION */}
                                                 <div className="bg-indigo-500/10 p-2 rounded border border-indigo-500/20 mb-2">
                                                     <div className="text-[9px] text-indigo-300 uppercase mb-1 flex items-center gap-1">
                                                        <Icon name="fingerprint" size={10}/> Identity Header
                                                     </div>
                                                     <div className="text-white font-bold">Wallet ID: 0x{block.walletID}</div>
                                                 </div>
                                                 <div className="text-slate-400">
                                                     Harvested <span className="text-white">{block.logCount}</span> offline logs.
                                                 </div>
                                                 <div className="text-[9px] text-slate-600 mt-2 truncate">Hash: {block.hash}...</div>
                                             </div>
                                         ))
                                     )}
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
